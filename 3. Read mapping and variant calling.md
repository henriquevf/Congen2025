# Read Mapping and Variant Calling 

## Part one: Read Mapping

### Quick review of file types for Read Mapping

- fastq files -> this file stores raw sequence data from the sequencing machine. For paired-read sequencing, wew ill obtain a Read 1 (R1) file and Read 1 (R2) file.  

Let's look at our fastq file: 

```
less /anvil/projects/x-bio240351/shared_data/fastq/CH0893_ACCTTGGC-ATGAGGCC_L001_R1_001.fastq.gz
```

The four lines correspond to: 
```
1. A sequence identifier with information about the sequencing run and the cluster. 

2. The sequence (the base calls; A, C, T, G and N).

3. A separator, which is simply a plus (+) sign.

4. The base call quality scores. These are Phred +33 encoded, using ASCII characters to represent the numerical quality scores.
```

- Let's look at our BAM file, which stands for Binary Alignment Map:
```
module load samtools 

samtools view /anvil/projects/x-bio240351/shared_data/bams/NA5206.loxAfr4_NC000934_subsampled.bam | less -S
```

<img width="746" alt="image" src="https://github.com/user-attachments/assets/b01666bf-fa37-4a7b-a48a-4507a56be965" />

- Mapping quality -> probability that the read is misaligned in the BAM file. Reported from 0 to 255, with a lower number higher quality. 
    - MAPQ score 20, then the probability of a correctly mapped read was 0.99
    - MAPQ score 30, then the probability of a correctly mapped read was 0.999

module load samtools
 samtools view /anvil/projects/x-bio240351/shared_data/bams/NA5206.loxAfr4_NC000934_subsampled.bam | cut -f 5 | sort | uniq  -c | sort -n | awk '{printf("MAPQ:%s\t%d\n",$2,$1);}' | gnuplot -e " set terminal dumb ;set nokey; plot '-' using 2:xtic(1) with boxes"



###  Alignment of reads to reference genome

First, we need to align our trimmed fastq files to the reference genome. 

> [!IMPORTANT]
> What is a reference genome and where did we get it? We can search for previously published reference genomes on the National Center for Biotechnology Information (NCBI)'s website (https://www.ncbi.nlm.nih.gov/search/)

- Click here: https://www.ncbi.nlm.nih.gov/search/
  
-  Type in African elephant into the search
  
-  How many African elephant reference genomes are there?
  
-  https://www.ncbi.nlm.nih.gov/datasets/genome/?taxon=9784

First, we need to make a job file that contains the script we want to run. 

```
cd /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling
touch 01_alignment.sh
```
Then we will copy and paste this information below into our alignment script: 

```
vim 01_alignment.sh
#paste the contents below
wq
```

Script for alignment
```
#!/bin/sh -l
#SBATCH -A bio240351  
#SBATCH -p wholenode 
#SBATCH --nodes=1
#SBATCH --ntasks=1 
#SBATCH --time=1:30:00
#SBATCH --job-name alignment
#SBATCH -o /anvil/scratch/YOUR_USERNAME/log/01_alignment.o%j
#SBATCH -e /anvil/scratch/YOUR_USERNAME/log/01_alignment.e%j

#load our modules

module load bwa
module load samtools

#We can list our files here, then call them later in the script

R1=/anvil/projects/x-bio240351/shared_data/fastq/NA5206_Namibia_R1.fastq
R2=/anvil/projects/x-bio240351/shared_data/fastq/NA5206_Namibia_R2.fastq
REF=/anvil/projects/x-bio240351/shared_data/reference/Chromosomes.v2.fasta
OUTDIR=/anvil/scratch/x-YOURNAME/03_readmapping_variantcalling

bwa index ${REF} #index the reference genome of the Elephant

bwa mem -R "@RG\tID:NA5206\tSM:NA5206" ${REF} ${R1} ${R2} | \
samtools view -q 10 -h -b - | \
samtools sort -o ${OUTDIR}/NamibiaElephant_NA5206.bam -
```
Then we can run the script: 
```
sbatch 01_alignment.sh
```

We can view the out file to see how the job is running: 

```
squeue -u x-YOURNAME
less /anvil/scratch/YOUR_USERNAME/log/01_alignment.e*
```

Let's check to see if the bam file is here and starting to be formed: 
```
module load samtools
samtools view /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/NamibiaElephant_NA5206.bam | less -S 
```
We can see the job is running. This will take a long time to align the fastq file to the reference genome, so we will use our previously made bam file. 

### Depth of our bam file

We will calculate the depth of our bam file. The **depth** is the average number of reads that align to a specific position on the reference genome. **Coverage** refers to the percentage of the genome that is coveraged by at least one reads. 

First, we need to create a job file to place our script into: 
```
cd /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling
touch 02_depth.sh
```

Then we will copy and paste this information below into our alignment script: 

```
vim 02_depth.sh
#paste the contents below
wq
```
Script for calculating depth for a bam file: 
```
#!/bin/sh -l
#SBATCH -A bio240351  
#SBATCH -p wholenode 
#SBATCH --nodes=1
#SBATCH --ntasks=1 
#SBATCH --time=1:30:00
#SBATCH --job-name depth
#SBATCH -o /anvil/scratch/YOUR_USERNAME/log/02_depth.o%j
#SBATCH -e /anvil/scratch/YOUR_USERNAME/log/02_depth.e%j

module load samtools

BAM=/anvil/projects/x-bio240351/shared_data/bams/NA5206.loxAfr4_NC000934_subsampled.bam

samtools depth ${BAM}  |  awk '{sum+=$3} END { print "Average = ",sum/NR}' > depth_NA5206.txt
```
Then we can run the script: 
```
sbatch  02_depth.sh

```
Now we can see a new file in our folder called `depth_NA5206.txt` by doing `ls`

```
less /anvil/projects/x-bio240351/shared_data/outputs/depth_NA5206.txt
```
> [!IMPORTANT]
> What is the depth of our bam file? 

### Visualizing read alignment 
There are a few programs where we can visualize read alignments, some including the Integrative Genome Viewer and tview in samtools. 

We will visualize some reads in the alignment using IGV (https://igv.org/doc/desktop/#DownloadPage/). If you want, download the IGV software so we can visualize some reads. 

Download the "wSierraMorena.CanFam31.realigned_TSHR.bam" and "wSierraMorena.CanFam31.realigned_TSHR.bam.bai" files onto your computer. 

Change the reference genome to "Canfam3.1" and upload the bam file under File -> Load File. Change the genomic coordinate location to be: "chr8:53,400,332-53,416,468". 

Now you can visualize the reads, quality of the reads, and where there are split reads and mate pairs. 

> [IMPORTANT!]
> What do we observe in the region "chr8:53,400,332-53,416,468"? What could explain the poor quality in mapping? 

### Calculating read flags 



## Part two: Variant Calling with GATK


The GATK (Genome Analysis Toolkit) is one of the most used programs for genotype calling in sequencing data in model and non model organisms. However, the GATK was designed to analyze human genetic data and all its pipelines are optimized for this purpose (https://gatk.broadinstitute.org/hc/en-us).

### Quick background on file types: 


- A fastq.gz file contains the raw reads that are not aligned to the reference genome. Let's see what a fastq.gz file looks like: 
```
less /anvil/projects/x-bio240351/shared_data/fastq/NA5206_AGTTGGCT-GCAACCAT_L003_R2_001.fastq.gz

```
- A bam file is called a Binary Alignment Map and it is a file where the reads of an individual are aligned to a reference genome. So we know where each read goes on the genome. 
```
samtools view /anvil/projects/x-bio240351/shared_data/bams/NA5206.loxAfr4_NC000934_subsampled.bam | less -S

```

- A variant call format (VCF) file contains the variants along the genome for a single individual, or multiple individuals. 
```
zless -S /anvil/projects/x-bio240351/shared_data/vcf/LoxAfr4_elephant_imputed_sites_variable_nomissing_maf005_no1stdegree.vcf.gz
```

### HaplotypeCaller
HaplotypeCaller calls SNPs and indels via local de-novo assembly of haplotypes. This means when it encounters a region showing signs of variation, it discards mapping information and reassembles the reads in that region. This just allows HaplotypeCaller to be more accurate wen calling regions that are typically difficult to call. 

First, we will make a new script for Haplotypecaller 
```
cd /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling
touch 03_GATK_HaplotypeCaller.sh
```

Then we can run the script:

```
#!/bin/bash
#SBATCH --job-name haplotypecaller
#SBATCH -A bio240351  # Allocation name
#SBATCH --nodes=1         # Total # of nodes (must be 1 for serial job)
#SBATCH --ntasks=1        # Total # of MPI tasks (should be 1 for serial job)
#SBATCH --time=1:30:00    # Total run time limit (hh:mm:ss)
#SBATCH -o /anvil/scratch/YOUR_USERNAME/log/haplotypecaller.o%j      # Name of stdout output file
#SBATCH -e /anvil/scratch/x-lhennelly/log/haplotypecaller.e%j      # Name of stderr error file
#SBATCH -p wholenode  # Queue (partition) name

module load gatk/4.1.8.1

BAM=/anvil/projects/x-bio240351/shared_data/bams/NA5206.loxAfr4_NC000934_subsampled.bam

REF=/anvil/projects/x-bio240351/shared_data/reference/Chromosomes.v2.fasta

gatk HaplotypeCaller \
-I ${BAM} \
-R ${REF} \
-ERC GVCF \
-O /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/NA5206.loxAfr4_NC000934_subsampled.g.vcf

```

mv samplemap.txt /anvil/projects/x-bio240351/shared_data/bams/


Let's sbatch the script and look at our output file to see the job running: 
```
sbatch 03_GATK_HaplotypeCaller.sh
squeue -u x-YOURNAME
less /anvil/scratch/YOUR_USERNAME/log/03_GATK_HaplotypeCaller.o%j

ls #And we can look at your g.vcf file being constructed with 
```

We can see the job is running, and if we refresh looking at `/anvil/scratch/YOUR_USERNAME/log/03_GATK_HaplotypeCaller.o%j` we can see it is computationally working. 

Let's look at the G.VCF file: 



### GenomeDBImport
This step creates a GenomicsDB datastore to speedup joint genotyping. This in prep for the Genotype calling.

First, we will make a script: 
```
cd /anvil/scratch/x-lhennelly/03_readmapping_variantcalling
touch 04_GATK_GenomeDBImport.sh
```

There's a few things we need to do in order to prepare for GenomeImport. We need to make a sample map: 
```
less /anvil/projects/x-bio240351/shared_data/bams/samplemap.txt
```

And we will make a directory for scratch and output of GenomeImport within our directory
```
mkdir /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/GenomeImport_scratch
mkdir /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/GenomeImport
```

Then we will paste this script below: 
```
#!/bin/bash
#SBATCH --job-name genomeImport
#SBATCH -A bio240351  # Allocation name
#SBATCH --nodes=1         # Total # of nodes (must be 1 for serial job)
#SBATCH --ntasks=1        # Total # of MPI tasks (should be 1 for serial job)
#SBATCH --time=1:30:00    # Total run time limit (hh:mm:ss)
#SBATCH -o /anvil/scratch/YOUR_USERNAME/log/genomeImport.o%j      # Name of stdout output file
#SBATCH -e /anvil/scratch/YOUR_USERNAME/log/genomeImport.e%j      # Name of stderr error file
#SBATCH -p wholenode  # Queue (partition) name

module load gatk/4.1.8.1

OUTDIR=/anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/GenomeImport
TEMPDIR=/anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/GenomeImport_scratch
SAMPLEMAP=/anvil/projects/x-bio240351/shared_data/bams/samplemap.txt

gatk GenomicsDBImport --genomicsdb-workspace-path ${OUTDIR}/elephant_gvcf_db --batch-size 50 -L chr1 --sample-name-map ${SAMPLEMAP} --tmp-dir ${TEMPDIR}
```

And we can run the file: 
```
sbatch 04_GATK_GenomeDBImport.sh
```

Then lets look at our Genomeimport directory: 
```
cd /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/GenomeImport
```
And our output file: 
```
/anvil/scratch/x-lhennelly/log/genomeImport.e%j 
```

### GenotypeGVCFs
Now we can perform joint genotyping that were pre-called with HaplotypeCaller.

- It will look at the available information for each site from both variant and non-variant alleles across all samples, and then produce a multi-sample VCF that contains only sites that are found as variant in at least one sample.

https://gatk.broadinstitute.org/hc/en-us/articles/360037057852-GenotypeGVCFs

Let's make a directory for our VCF output:
```
mkdir /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/GenotypeGVCF
mkdir /anvil/scratch/x-YOURNAME/03_readmapping_variantcalling/GenotypeGVCF_scratch
```
Now we can make a job file and paste our script into it: 
```
touch 05_GATK_GenotypeGVCFs.sh
```

Now let's run the job file:
```
#!/bin/bash
#SBATCH --job-name genotypecaller
#SBATCH -A bio240351  # Allocation name
#SBATCH --nodes=1         # Total # of nodes (must be 1 for serial job)
#SBATCH --ntasks=1        # Total # of MPI tasks (should be 1 for serial job)
#SBATCH --time=1:30:00    # Total run time limit (hh:mm:ss)
#SBATCH -o /anvil/scratch/x-lhennelly/log/05_GATK_GenotypeGVCFs.o%j      # Name of stdout output file
#SBATCH -e /anvil/scratch/x-lhennelly/log/05_GATK_GenotypeGVCFs.e%j      # Name of stderr error file
#SBATCH -p wholenode  # Queue (partition) name

module load gatk/4.1.8.1

REF=/anvil/projects/x-bio240351/shared_data/reference/Chromosomes.v2.fasta
OUTDIR=/anvil/scratch/x-lhennelly/03_readmapping_variantcalling/GenotypeGVCF
TEMPDIR=/anvil/scratch/x-lhennelly/03_readmapping_variantcalling/GenotypeGVCF_scratch

cd /anvil/scratch/x-lhennelly/03_readmapping_variantcalling/GenomeImport

gatk GenotypeGVCFs -R ${REF} -V gendb://elephant_gvcf_db -O ${OUTDIR}/gatk_Elephants.vcf.gz --tmp-dir ${TEMPDIR}
```
And we can look at our results: 
```
cd /anvil/scratch/x-lhennelly/03_readmapping_variantcalling/GenotypeGVCF
less gatk_Elephants.vcf.gz
```

Let's look at the multi-sample VCF we will use for the course, with all elephant samples: 
```
zless -S /anvil/projects/x-bio240351/shared_data/vcf/LoxAfr4_elephant_imputed_sites_variable_nomissing_maf005_no1stdegree.vcf.gz

```
We can also find the information associated with each genotype call. For example
```

```


## Things to consider and filtering the VCF 



```
#!/bin/sh -l
#SBATCH -A bio240351  
#SBATCH -p wholenode 
#SBATCH --nodes=1
#SBATCH --ntasks=1 
#SBATCH --time=1:30:00
#SBATCH --job-name GATK_HaplotypeCaller
#SBATCH -o 03_GATK_HaplotypeCaller_CH0893_Botswana.out
#SBATCH -e 03_GATK_HaplotypeCaller_CH0893_Botswana.err

module load gatk/4.1.8.1

BAM=/anvil/scratch/x-hfigueiro/CH0893_Botswana.loxAfr4_NC000934.bam

module load samtools
samtools index /anvil/scratch/x-hfigueiro/CH0893_Botswana.loxAfr4_NC000934_subsample.bam

REF=/anvil/scratch/x-hfigueiro/Chromosomes.v2.fasta

gatk HaplotypeCaller \
-I ${BAM} \
-R ${REF} \
-ERC GVCF \
-O /anvil/scratch/x-YOURNAME/Results_Alignment_SNPcalling/CH0893_Botswana.loxAfr4_NC000934_subsampled.gvcf
```





