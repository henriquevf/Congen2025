# SNV Density plot tutorial

This tutorial demonstrates how to calculate and visualize **SNP density** to explore genetic diversity across a genome. SNP density visualizations are especially useful for comparing genetic diversity between populations or species. Here, we generalize the dataset and workflow for broad applicability.

**Workflow Overview**

1. **Prepare SNP Data**: Extract heterozygous positions.
2. **Calculate SNP Density**: Count SNPs in genome windows.
3. **Annotate Output**: Add sample identifiers to results.
4. **Combine Results**: Create a single dataset for visualization.
5. **Visualize Data**: Use R to generate SNP density plots.

**Section 1: Setting Up the Environment**

Start by setting up your workspace and organizing files:

```bash
mkdir -p snpden/plots
cd snpden
```

Ensure the following are installed:

- **VCFtools**: For SNP filtering and density calculation.
- **R and tidyverse**: For visualization.

**Section 2: SNP Data Preparation**

**Extract Heterozygous Sites**

Filter heterozygous positions.

```bash
for file in /path/to/vcfs/*.vcf.gz; do
sample=$(basename "$file" .vcf.gz)
bcftools view -i 'GT="het"' "$file" -Oz -o "${sample}_hets.vcf.gz"
done
```

**Explanation:**

1. `bcftools view`
    - This is the command to filter or manipulate VCF/BCF files.
    - The view subcommand specifically allows you to filter variants based on various criteria (e.g., genotype, depth, quality).
2. `-i 'GT="het"'`
    - `-i`: Stands for “include.” It filters variants that satisfy the condition provided.
    - `GT="het"`: The condition that checks if the genotype (GT field) is heterozygous.
    - In VCF files:
        - `0/0` = homozygous reference.
        - `1/1` = homozygous alternate.
        - `0/1` or `1/2` = heterozygous.
        - This parameter ensures that only sites with heterozygous genotypes are retained in the output.
3. `input.vcf.gz` 
    - Specifies the input VCF file in compressed format (.vcf.gz). The input file contains the raw or filtered variants before genotype filtering.
4. `-Oz`
    - -O: Specifies the output format.
    - z: Indicates that the output file should be compressed in the .vcf.gz format.
    - This compression saves disk space and is standard for large genomic files.
5. `-o output_hets.vcf.gz`
    - `-o`: Specifies the output file name.
    - `output_hets.vcf.gz`: The name of the file that will store the filtered variants. This file contains only the positions with heterozygous genotypes.

**Section 3: Calculate SNP Density**

Calculate SNP density in genome windows (e.g., 1 Mb):

```bash
for file in *_hetsites.recode.vcf; do
name=$(basename "$file" .recode.vcf)
vcftools --vcf "$file" --SNPdensity 1000000 --out "${name}_density"
done
```

**Explanation:**

- `--vcf`: Input VCF file.
- `--SNPdensity 1000000`: Compute SNP density in 1 Mb windows.
- `--out`: Specify output file prefix.

**Section 4: Annotate Outputs**

Add sample identifiers to the SNP density results for clarity:

```bash
for file in *_density.snpden; do
sample=$(basename "$file" _density.snpden)
awk -v sample="$sample" 'NR==1 {print $0 "\tSample"} NR>1 {print $0 "\t" sample}' "$file" > "${sample}_annotated.snpden"
done
```

**Explanation:**

- `awk`: Adds a “Sample” column with the sample name.
- `NR==1`: Apply to the first line (header).
- `NR>1`: Apply to all other lines.

**Section 5: Combine Results**

Merge all annotated SNP density files into a single dataset:

```bash
tail -q -n +2 *_annotated.snpden > combined_snp_density.snpden
```

**Explanation:**

- `tail -q -n +2`: Skip headers and concatenate all files into one.
- Output: `combined_snp_density.snpden`.

**Section 6: Visualize SNP Density in R**

**Plot SNP Density Across Chromosomes**

Save the following script as snp_density_plot.R:

```r
*# Load required libraries*
library(tidyverse)

*# Set working directory*
setwd("path/to/snpden")

*# Load data*
snpden <- read.table("combined_snp_density.snpden", header = TRUE)
*# Reorder chromosomes if needed*
chromosome_order <- c("chr1", "chr2", "chr3", "chrX")  *# Update as necessary*
snpden$CHROM <- factor(snpden$CHROM, levels = chromosome_order)

*# Visualize SNP density*
ggplot(snpden, aes(x = BIN_START, y = VARIANTS.KB, fill = Sample)) +
geom_tile() +
facet_wrap(~CHROM, scales = "free_x") +
scale_fill_viridis_d() +
labs(title = "SNP Density Across Chromosomes",
x = "Position (bp)",
y = "SNPs per kb",
fill = "Sample") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))

*# Save the plot*
ggsave("plots/snp_density_plot.png", width = 10, height = 6)
```

**Explanation:**

- **Input File**: `combined_snp_density.snpden`.
- **Variables**:
- `BIN_START`: Window start position.
- `VARIANTS.KB`: SNP density (variants per kb).
- Sample: Sample identifier.
- **Plot Customization**:
- `facet_wrap(~CHROM)`: Separate plots by chromosome.
- `geom_tile()`: Create a heatmap.

**Section 7: Best Practices and Tips**

1. **Window Size**:
- Choose based on genome size and diversity.
- Use smaller windows (e.g., 100 kb) for detailed analyses, larger windows (e.g., 1 Mb) for broad trends.
1. **Quality Control**:
- Filter SNPs (e.g., depth, quality) before analysis.
- Remove regions with excessive missing data or low coverage.

3.	**Customization**:

- Modify the R script to match your dataset (e.g., chromosome names).
- Adjust color schemes and labels for better presentation.

**Conclusion**

This workflow allows you to calculate and visualize SNP density effectively across multiple samples and chromosomes. The automated scripts and flexible plotting options ensure scalability and reproducibility, making it suitable for diverse datasets.

### Job file

```bash
#!/bin/bash
#SBATCH --job-name snpden
#SBATCH -A bio240351  # Allocation name
#SBATCH --nodes=1         # Total # of nodes (must be 1 for serial job)
#SBATCH --ntasks=1        # Total # of MPI tasks (should be 1 for serial job)
#SBATCH --mem=512M          # Memory allocation
#SBATCH --time=0:30:00    # Total run time limit (hh:mm:ss)
#SBATCH -o /anvil/scratch/YOUR_USERNAME/log/snpden.o%j      # Name of stdout output file
#SBATCH -e /anvil/scratch/YOUR_USERNAME/log/snpden.e%j      # Name of stderr error file
#SBATCH -p wholenode  # Queue (partition) name

# Load required modules
module load bcftools
module load vcftools

# Parameters

WINDOW_SIZE=1000000  # SNP density window size
VCF_DIR="/path/to/vcfs"  # Directory containing VCF files
OUTPUT_DIR="snpden"  # Directory for output files
MAF=0.1  # Minimum allele frequency filter
PLOT_DIR="${OUTPUT_DIR}/plots"  # Directory for plots

# Create output directories

mkdir -p "${OUTPUT_DIR}" "${PLOT_DIR}"

# Process each VCF file

for file in "${VCF_DIR}"/*.vcf.gz; do
sample=$(basename "$file" .vcf.gz)

# Extract heterozygous sites using BCFtools
bcftools view -i 'GT="het"' "$file" -Oz -o "${OUTPUT_DIR}/${sample}_hets.vcf.gz"

# Calculate SNP density using VCFtools
vcftools --gzvcf "${OUTPUT_DIR}/${sample}_hets.vcf.gz" \\
         --SNPdensity "${WINDOW_SIZE}" \\
         --out "${OUTPUT_DIR}/${sample}_density"

# Add sample name to SNP density file
awk -v sample="$sample" 'NR==1 {print $0 "\\tSample"} NR>1 {print $0 "\\t" sample}' \\
    "${OUTPUT_DIR}/${sample}_density.snpden" > "${OUTPUT_DIR}/${sample}_annotated.snpden"
    done
    
# Combine annotated SNP density files

tail -q -n +2 "${OUTPUT_DIR}"/*_annotated.snpden > "${OUTPUT_DIR}/combined_snp_density.snpden"

echo "SNP density calculations complete. Combined file: ${OUTPUT_DIR}/combined_snp_density.snpden"
```
