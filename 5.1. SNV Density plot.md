# SNV Density plot tutorial

This tutorial demonstrates how to calculate and visualize **SNP density** to explore genetic diversity across a genome. SNP density visualizations are especially useful for comparing genetic diversity between populations or species. 

There is a job file at the end of this tutorial with all the steps required to run the analysis. You **DO NOT** need to write each command separately. 

**Workflow Overview**

1. **Prepare SNP Data**: Extract heterozygous positions.
2. **Calculate SNP Density**: Count SNPs in genome windows.
3. **Annotate Output**: Add sample identifiers to results.
4. **Combine Results**: Create a single dataset for visualization.
5. **Visualize Data**: Use R to generate SNP density plots.

**Section 1: Setting Up the Environment**

```bash
# Parameters
WINDOW_SIZE=1000000  # SNP density window size
VCF_FILE="/anvil/projects/x-bio240351/shared_data/05_genetic_diversity/elephants.chr.11.12.subset.vcf.gz"  # Input multi-individual VCF file
OUTPUT_DIR="/anvil/scratch/$(whoami)/snpden"  # Directory for output files
PLOT_DIR="${OUTPUT_DIR}/plots"  # Directory for plots
# Create output directories
mkdir -p "${OUTPUT_DIR}" "${PLOT_DIR}"
# Step 1: Extract sample names from the VCF
```

**Parameters**

`WINDOW_SIZE=1000000`:

- Sets the SNP density window size (1,000,000 base pairs). This is used later for SNP density calculations.

VCF_FILE:

- The path to the input VCF file containing genetic data for multiple individuals.
- In this case: `"/anvil/projects/x-bio240351/shared_data/05_genetic_diversity/elephants.chr.11.12.subset.vcf.gz"`.

OUTPUT_DIR:

- Specifies the directory where all output files (filtered VCFs, SNP density results, plots) will be saved.
- Uses $(whoami) to ensure the directory is user-specific.

PLOT_DIR:

- Subdirectory for saving visualization plots.

`mkdir -p`:

- Creates the OUTPUT_DIR and PLOT_DIR directories if they don’t already exist.

**Step 2: Process Each Sample**

The workflow iterates through each sample in SAMPLE_NAMES using a for loop.

```bash
# Step 2: Process each individual
for sample in $SAMPLE_NAMES; do
    echo "Processing sample: $sample"

    # Step 2.1: Extract individual's VCF
    bcftools view -c 1 -s "$sample" -Oz -o "${OUTPUT_DIR}/${sample}.vcf.gz" "$VCF_FILE"
    bcftools index "${OUTPUT_DIR}/${sample}.vcf.gz"
```

**Step 2.1: Extract Individual’s VCF**

`bcftools view -c 1 -s "$sample" -Oz -o "${OUTPUT_DIR}/${sample}.vcf.gz" "$VCF_FILE"`

- `bcftools view`:
    - Extracts a single sample’s VCF from the multi-sample VCF.
    - `-c 1`:
    - Ensures at least one allele is present for the variant.
    - `-s "$sample"`:
    - Specifies the sample name to extract.
    - `-Oz`:
    - Outputs the resulting VCF in compressed .vcf.gz format.
    - `-o "${OUTPUT_DIR}/${sample}.vcf.gz"`:
    - Specifies the output file for the extracted VCF.

**Index the Extracted VCF**

`bcftools index "${OUTPUT_DIR}/${sample}.vcf.gz"`

- Indexes the extracted VCF file to enable quick access by genomic position.

**Section 2: SNP Data Preparation**

**Extract Heterozygous Sites**

Filter heterozygous positions.

```bash
#Extract heterozygous positions using bcftools query
 
	bcftools query -f '%CHROM\t%POS\t%REF\t%ALT\t[%GT]\n' "${OUTPUT_DIR}/${sample}.vcf.gz" \
	| grep -w "0/1" \
	> "${OUTPUT_DIR}/${sample}_hets.txt"

  echo "Heterozygous positions for $sample extracted."
```

**Explanation:**

`bcftools query`:

- The query command extracts specific fields from the VCF file.
    - `-f '%CHROM\t%POS\t%REF\t%ALT\t[%GT]\n'`:
    - `%CHROM`: Chromosome identifier.
    - `%POS`: Position on the chromosome.
    - `%REF`: Reference allele.
    - `%ALT`: Alternate allele.
    - `%GT`: Genotype for each sample in the VCF file. The [ ] syntax ensures that all genotypes for multi-sample VCFs are included.
    - `\t`: Adds a tab between fields.
    - `\n`: Ends the line after each record.

**Piping to** grep:

- `grep -w "0/1"`:
    - Filters records where the genotype (GT) is exactly 0/1, representing heterozygous positions.
    - `-w`: Ensures an exact word match (avoids matching 10/1 or similar patterns).

**Output to File**:

- `> "${OUTPUT_DIR}/${sample}_hets.txt"`:
- Writes the filtered results to a text file. The file contains heterozygous positions for the specific sample, with fields for chromosome, position, reference allele, alternate allele, and genotype.

```bash
	#Convert heterozygous positions back to VCF format
  bcftools view -R <(awk '{print $1 "\t" $2}' "${OUTPUT_DIR}/${sample}_hets.txt") \
  "${OUTPUT_DIR}/${sample}.vcf.gz" -Oz -o "${OUTPUT_DIR}/${sample}_hets.vcf.gz"
  bcftools index "${OUTPUT_DIR}/${sample}_hets.vcf.gz"

  echo "Heterozygous VCF for $sample created."
```

`awk` **Command**:

- `awk '{print $1 "\t" $2}'`:
- Extracts the first two fields (chromosome and position) from the heterozygous positions file `(${sample}_hets.txt)`.
- These fields `(%CHROM and %POS)` are necessary to define which positions to extract from the VCF.
- `<()`:
- Creates a process substitution, allowing the output of `awk` to be used as input for `bcftools view.`

`bcftools view`:

- `-R`:
- Specifies a file (or process substitution) containing a list of regions to extract.
- The format requires tab-delimited CHROM\tPOS.
- `${OUTPUT_DIR}/${sample}.vcf.gz`:
- Input VCF file for the specific sample.
- `-Oz`:
- Outputs the filtered VCF in compressed .vcf.gz format.
- `-o "${OUTPUT_DIR}/${sample}_hets.vcf.gz"`:
- Specifies the output file, which contains only heterozygous positions in VCF format.

**Index the output VCF**

```bash
bcftools index "${OUTPUT_DIR}/${sample}_hets.vcf.gz"
```

- Creates an index file for the filtered VCF (.tbi), which is necessary for downstream tools that require indexed input.

**Section 3: Calculate SNP Density**

Calculate SNP density in genome windows (e.g., 1 Mb):

```bash
for file in *_hetsites.recode.vcf; do
name=$(basename "$file" .recode.vcf)
vcftools --vcf "$file" --SNPdensity 1000000 --out "${name}_density"
done
```

**Explanation:**

- `--vcf`: Input VCF file.
- `--SNPdensity 1000000`: Compute SNP density in 1 Mb windows.
- `--out`: Specify output file prefix.

**Section 4: Annotate Outputs**

Add sample identifiers to the SNP density results for clarity:

```bash
for file in *_density.snpden; do
sample=$(basename "$file" _density.snpden)
awk -v sample="$sample" 'NR==1 {print $0 "\tSample"} NR>1 {print $0 "\t" sample}' "$file" > "${sample}_annotated.snpden"
done
```

**Explanation:**

- `awk`: Adds a “Sample” column with the sample name.
- `NR==1`: Apply to the first line (header).
- `NR>1`: Apply to all other lines.

**Section 5: Combine Results**

Merge all annotated SNP density files into a single dataset:

```bash
tail -q -n +2 *_annotated.snpden > combined_snp_density.snpden
```

**Explanation:**

- `tail -q -n +2`: Skip headers and concatenate all files into one.
- Output: `combined_snp_density.snpden`.

**Section 6: Visualize SNP Density in R**

**Plot SNP Density Across Chromosomes**

The script below works as a standalone script. If you have results you can download to your computer and use it to plot the results.

Save the following script as `snp_density_plot.R`:

```r
# Set the working directory to where the data files are located
setwd("/Congen2025/Dataset/") #CHANGE HERE

# Load required packages
library(tidyverse)
library(gdata)
lib
